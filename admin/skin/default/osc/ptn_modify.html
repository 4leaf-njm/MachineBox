{ #layout_header }

<style style="text/css">
	.btnhelp {display:inline-block; width:14px; height:14px; cursor:pointer; background:url('../images/common/bg_icon.png'); vertical-align:middle;margin-bottom:2px}
</style>
<script type="text/javascript" src="/app/javascript/plugin/jquery.fmdomsaver.js"></script>
<script type="text/javascript" src="/app/javascript/plugin/jquery.colorpicker.min.js"></script>
<script type="text/javascript" src="/app/javascript/plugin/custom-color-picker.js"></script>
<script type="text/javascript" src="/app/javascript/js/admin-goodsQuickRegist.js"></script>

<!-- 페이지 타이틀 바 : 시작 -->
<div id="page-title-bar-area">
	<div id="page-title-bar">
		<!-- 타이틀 -->
		<div class="page-title">
			<h2>파트너정보 수정</h2>
		</div>

		<!-- 좌측 버튼 -->
		<ul class="page-buttons-left"></ul>

		<!-- 우측 버튼 -->
		<ul class="page-buttons-right"></ul>
	</div>
</div>
<!-- 페이지 타이틀 바 : 끝 -->
<br style="line-height:30px;" />

<form action="../osc/ptn_modify_process" method="post" id="frm_regist" enctype="multipart/form-data">
<input type="hidden" name="ptn_seq" value="{partner_seq}" />
<div class="pofol_picture_seq_div"></div>
<div class="clearbox">
	<ul class="left-btns clearbox">
		<li>
			<span class="btn small black"><button type="button" onclick="go_partner_modify()">수정</button></span>
		</li>
	</ul>
</div>
<table class="info-table-style quick-goods-regist-table" width="100%" style="margin-bottom: 40px;">
<thead>
<tr>
	<th colspan="7" class="its-th-align center">기본 정보</th>
</tr>
<tr>
	<th class="its-th-align center" width="80">프로필</th>
	<th class="its-th-align center" width="150">업력</th>
	<th class="its-th-align center" width="150">업종</th>
	<th class="its-th-align center" width="120">지역</th>
	<th class="its-th-align center" width="150">카테고리</th>
	<th class="its-th-align center" width="300">주서비스</th>
	<th class="its-th-align center" width="*">자기소개</th>
</tr>
</thead>
<tbody class="quick-goods-regist-tbody">
<tr class="option-rows" style="height: 50px;">
	<td class="its-td-align left pd10 seller-box" style="vertical-align:top;">
		<div class="picture-list">
	       <div class="preview-div" style="margin: 0 auto;">
	           <label for="profile_image" class="btn-picture-add">
	               <div class="preview-back" id="bg_profile"></div>
	               <p class="preview-txt">프로필</p>
	               <input type="file" name="profile_image" class="input-file" id="profile_image">
	           </label>
	       </div>
     </div>
	</td>
	<td class="its-td-align center seller-box" style="vertical-align:top;">
		<input type="text" name="career_year" style="width: 85%;"/>
		
	</td>
	<td class="its-td-align center seller-box" style="vertical-align:top;">
		<input type="text" name="career_type" style="width: 85%;"/>
	</td>
	<td class="its-td-align center seller-box" style="vertical-align:top;">
		<input type="hidden" name="area_seq" />
		<select name="sel_area" class="simple" style="width:100%;">
			<!-- {@ area_list} -->
            <option data-seq="{.area_seq}">{.area_name}</option>
            <!-- {/} -->
		</select>
	</td>
	<td class="its-td-align center seller-box" style="vertical-align:top;">
		<input type="hidden" name="cate_seq" />
        <select name="sel_cate" class="simple" style="width: 100%;">
             <option>카테고리</option>
             <!-- {@ cate_list} -->
             <option data-seq="{.cate_seq}">{.cate_name}</option>
             <!-- {/} -->
         </select>
	</td>
	<td class="its-td-align center seller-box" style="vertical-align:top;">
		<input type="text" name="main_service" style="width: 85%;" />
	</td>
	<td class="its-td-align center seller-box" style="vertical-align:top;">
		<textarea name="introduce" class="simple" style="width: 90%; height: 65px;"></textarea>
	</td>
</tr>
</tbody>
</table>

<div class="clearbox">
	<ul class="left-btns clearbox">
		<li>
			<span class="btn small"><button type="button" onclick="add_cert_div()">추가</button></span>
		</li>
		<li>
			<span class="btn small"><button type="button" onclick="remove_cert_div()">제거</button></span>
		</li>
	</ul>
</div>
<div id="cert-div-wrap"></div>
<div id="cert-div-clone" class="hide">
	<div class="cert-div">
		<input type="hidden" name="cert_seq_arr[]" />
		<table class="info-table-style quick-goods-regist-table" width="100%" style="margin-bottom: 40px;">
			<thead>
			<tr>
				<th colspan="5" class="its-th-align center">자격증 정보</th>
			</tr>
			<tr>
				<th class="its-th-align center" width="60">선택</th>
				<th class="its-th-align center" width="*">자격증명</th>
				<th class="its-th-align center" width="300">자격증 발행일</th>
				<th class="its-th-align center" width="300">자격증 발행기관</th>
			</tr>
			</thead>
			<tbody class="quick-goods-regist-tbody">
			<tr class="option-rows" style="height: 50px;">
				<td class="its-td-align center seller-box" >
					<input type="checkbox" name="chk_cert" />
				</td>
				<td class="its-td-align center seller-box" style="vertical-align:top;">
					<input type="text" name="cert_name_arr[]" style="width: 85%;" />
				</td>
				<td class="its-td-align center seller-box" style="vertical-align:top;">
					<input type="text" name="cert_date_arr[]" style="width: 85%;" />
				</td>
				<td class="its-td-align center seller-box" style="vertical-align:top;">
					<input type="hidden" name="cert_org_arr[]" />	
					<div class="org_list">
						<input type="text" name="cert_org" style="margin-bottom: 3px; width: 85%;"/>
					</div>
					<span class="btn small valign-middle" style="margin-top: 2px;"><input type="button" value="추가" class="btn_cert_org_add"/></span>
				</td>
			</tr>
			</tbody>
		</table>
	</div>
</div>

<div class="clearbox">
	<ul class="left-btns clearbox">
		<li>
			<span class="btn small"><button type="button" onclick="add_pofol_div()">추가</button></span>
		</li>
		<li>
			<span class="btn small"><button type="button" onclick="remove_pofol_div()">제거</button></span>
		</li>
	</ul>
</div>
<div id="pofol-div-wrap"></div>
<div id="pofol-div-clone" class="hide">
	<div class="pofol-div">
		<input type="hidden" name="pofol_seq_arr[]" />	
		<table class="info-table-style quick-goods-regist-table" width="100%" style="margin-bottom: 40px;">
			<thead>
			<tr>
				<th colspan="7" class="its-th-align center">포트폴리오 정보</th>
			</tr>
			<tr>
				<th class="its-th-align center" width="60">선택</th>
				<th class="its-th-align center" width="180">관련자료</th>
				<th class="its-th-align center" width="250">포트폴리오명</th>
				<th class="its-th-align center" width="200">카테고리 분류</th>
				<th class="its-th-align center" width="180">시작일</th>
				<th class="its-th-align center" width="180">종료일</th>
				<th class="its-th-align center" width="*">수행내용</th>
			</tr>
			</thead>
			<tbody class="quick-goods-regist-tbody">
			<tr class="option-rows" style="height: 50px;">
				<td class="its-td-align center seller-box">
					<input type="checkbox" name="chk_pofol" />
				</td>
				<td class="its-td-align center seller-box" style="vertical-align:top;">
					<div class="pofol_picture_div">
						<p class="pofol_picture"></p>
						<input type="file" class="input-file" name="pofol_picture_1[]" id="picture-1-1">
						<p class="pofol_picture"></p>
						<input type="file" class="input-file" name="pofol_picture_1[]" id="picture-1-2">
						<p class="pofol_picture"></p>
						<input type="file" class="input-file" name="pofol_picture_1[]" id="picture-1-3">
						<p class="pofol_picture"></p>
						<input type="file" class="input-file" name="pofol_picture_1[]" id="picture-1-4">
					</div>					
					<label for="picture-1-1" class="btn small valign-middle" style="margin-top: 2px;"> 
						<input type="button" value="추가" class="btn_pofol_picture_add"/>
					</label>			
				</td>
				<td class="its-td-align center seller-box" style="vertical-align:top;">
					<input type="text" name="pofol_name_arr[]" style="width: 85%;" />
				</td>
				<td class="its-td-align center seller-box" style="vertical-align:top;">
					<input type="hidden" name="pofol_cate_arr[]" />
					<select name="sel_pofol_cate" class="simple" style="width: 100%;">
			            <option>기계 자격증</option>
			            <option>수리 자격증</option>
			            <option>기타 자격증</option>
			        </select>
				</td>
				<td class="its-td-align center seller-box" style="vertical-align:top;">
					<input type="text" name="start_date_arr[]" style="width: 80%;" />
				</td>
				<td class="its-td-align center seller-box" style="vertical-align:top;">
					<input type="text" name="end_date_arr[]" style="width: 80%;" />
				</td>
				<td class="its-td-align center seller-box" style="vertical-align:top;">
					<textarea name="pofol_content_arr[]" class="simple" style="width: 90%; height: 65px;"></textarea>
				</td>
			</tr>
			</tbody>
		</table>
	</div>
</div>
</form>
<style>
	.pofol_picture {
		font-size: 11px;
		color: #333;
		padding: 0 10px 2px;
		margin-bottom: 3px;
		border-bottom: 1px dashed rgba(180, 180, 180, 1);
		min-height: 22px;
	}
</style>	
<!--{? getSessionFlashdata('message') }-->
<script>
    alert('{= getSessionFlashdata('message')}');
</script>
<!--{/}-->	
<script>
$(document).on('click', '.btn_cert_org_add', function() {
	var html = '<input type="text" name="cert_org" style="margin-bottom: 3px; width: 85%;"/>';
	$(this).parents('td').find('.org_list').append(html);
});

$(document).on('click', '.btn_pofol_picture_add', function() {
	var result = false;
	$.each($(this).parents('td').find('.pofol_picture'), function(index, value){
    	if($(this).text() == '') {
    		result = true;
    		return false;
    	}
    });
    if(result == false) {
    	alert('더이상 추가하실 수 없습니다.');
    	return;
    }
    $(this).parent().trigger('click');
});

$(document).on('change', '.pofol_picture_div .input-file', function(e){
    var files = e.target.files;
    var filesArr = Array.prototype.slice.call(files);

    var reader = new FileReader();
    var preview = '';
    var $this = $(this);
    $.each($this.parent().find('.pofol_picture'), function(index, value){
    	if($(this).text() == '') {
    		preview = $(this);
    		return false;
    	}
    });

    filesArr.forEach(function(f) {
        if(!/\.(gif|jpg|jpeg|png|hwp|pdf)$/i.test(f.name)) {
            alert('이미지, 한글, pdf 파일만 첨부 가능합니다.');
            return;
        }
        reader.onload = function(e) {
           preview.text(f.name);
           $.each($this.parent().find('.pofol_picture'), function(index, value){
		    	if($(this).text() == '') {
		    		$this.parents('td').find('label').attr('for', $(this).next().attr('id'));
		    		return false;
		    	}
		    });
        }
       reader.readAsDataURL(f);
    });
});

var cert_html = $('#cert-div-clone').html();
var pofol_html = $('#pofol-div-clone').html();
$('#cert-div-wrap').html(cert_html);
$('#pofol-div-wrap').html(pofol_html);

var ptn_seq = '{partner_seq}';

$.ajax({
	type: 'post',
	url: 'ajax_get_ptn',
	dataType: 'json',
	data: {'ptn_seq': ptn_seq},
	success: function(data) {
		$.each($('select[name=sel_cate] option'), function(index, value) {
			if($(this).data('seq') == data.cate_seq)
				$(this).prop('selected', true);
		});
		
		$.each($('select[name=sel_area] option'), function(index, value) {
			if($(this).data('seq') == data.area_seq)
				$(this).prop('selected', true);
		});
		$('input[name=career_year]').val(data.career_year);
		$('input[name=career_type]').val(data.career_type);
		$('input[name=main_service]').val(data.main_service);
		$('textarea[name=introduce]').val(data.introduce);
		
		$('#bg_profile').css('background-image', "url('" + data.profile_path + "')");
		/*
		if(data.cert_list.length == 0) {
			$('#cert-div-clone input[name=cert_name]').attr('value', '');
			$('#cert-div-clone input[name=cert_date]').attr('value', '');
			var html = '<input type="text" name="cert_org_arr[]" style="margin-bottom: 3px; width: 85%;"/>';
			$('#cert-div-clone .org_list').html(html);
			html = '<input type="text" name="cert_tech_arr[]" style="margin-bottom: 3px; width: 85%;"/>';
			$('#cert-div-clone .tech_list').html(html);
			
			$('#cert-div').html($('#cert-div-clone').html());
			$('.datepicker').datepicker(options);
		} */
		
		if(data.cert_list.length > 0) {
			$('#cert-div-wrap').html('');
			$.each(data.cert_list, function(index, value) {
				$("#cert-div-clone input[name='cert_seq_arr[]']").attr('value', value.cert_seq);
				$("#cert-div-clone input[name='cert_name_arr[]']").attr('value', value.cert_name);
				$("#cert-div-clone input[name='cert_date_arr[]']").attr('value', value.cert_date);
				
				$('#cert-div-clone .org_list input').remove();
				var org_list = value.cert_org.split(',');
				if(org_list.length == 0) {
					var html = '<input type="text" name="cert_org" style="margin-bottom: 3px; width: 85%;"/>';
					$('#cert-div-clone .org_list').append(html);
				} else {
					$.each(org_list, function(index, value) {
						var html = '<input type="text" name="cert_org" value="' + value + '" style="margin-bottom: 3px; width: 85%;"/>';
						$('#cert-div-clone .org_list').append(html);
					});
				}
				$('#cert-div-wrap').append($('#cert-div-clone').html());
			});
		}
		
		if(data.pofol_list.length > 0) {
			$('#pofol-div-wrap').html('');

			$.each(data.pofol_list, function(index, value) {
				$.each($('#pofol-div-clone select[name=sel_pofol_cate] option'), function(idx, val) {
					if($(this).text().replace(' ') == value.pofol_cate.replace(' ')) {
						$(this).attr('selected', 'selected');
					}
				});
				$("#pofol-div-clone input[name='pofol_seq_arr[]']").attr('value', value.pofol_seq);
				$("#pofol-div-clone input[name='pofol_name_arr[]']").attr('value', value.pofol_name);
				$("#pofol-div-clone input[name='start_date_arr[]']").attr('value', value.start_date);
				$("#pofol-div-clone input[name='end_date_arr[]']").attr('value', value.end_date);
				$("#pofol-div-clone textarea[name='pofol_content_arr[]']").text(value.pofol_content);
				
				var cnt = $('.pofol-div').length;
				$.each($('#pofol-div-clone .pofol_picture_div .input-file'), function(index, value) {
					$(this).attr('name', 'pofol_picture_' + cnt + '[]');
					$(this).attr('id', 'picture-' + cnt + '-' + (index+1));
				});
				$.each(value.picture_list, function(idx, val) {
					$('#pofol-div-clone .pofol_picture').eq(idx).text(val.path.split('/')[4]);
					var seq_html = '<input type="hidden" name="pofol_picture_seq[]" value="' + val.picture_seq + '" />';
					$('.pofol_picture_seq_div').append(seq_html);
				});
				$('#pofol-div-clone .pofol_picture_div').parents('td').find('label').attr('for', 'picture-' + cnt + '-' + (value.picture_list.length + 1));
				var html = '';
				
				$('#pofol-div-wrap').append($('#pofol-div-clone').html());
				$('#pofol-div-clone').html(pofol_html);
			});
		}
	
	},
	error: function(request,status,error) {
		console.log('error');
	}
});

function go_partner_modify() {
	if(confirm('입력하신 내용으로 변경하시겠습니까 ?')) {
		$.each($('.org_list input'), function(index, value) {
			if($(this).val() == '') {
				$(this).remove();
			}
		});
	    $('input[name=cate_seq]').val($('select[name=sel_cate] option:selected').data('seq')); 
	    $('input[name=area_seq]').val($('select[name=sel_area] option:selected').data('seq'));
	    
	    $.each($('.cert-div table'), function(index, value) {
	    	var org_list = $(this).find('input[name=cert_org]');
	    	var cert_org = '';
	    	$.each(org_list, function(i, v) {
	    		cert_org += cert_org == '' ? $(this).val() : ',' + $(this).val();
	    	});
	    	$(this).find("input[name='cert_org_arr[]']").val(cert_org);
	    });
	    
	    $.each($('.pofol-div table'), function(index, value) {
	    	var pofol_cate = $(this).find('select[name=sel_pofol_cate] option:selected').text();
	    	$(this).find("input[name='pofol_cate_arr[]']").val(pofol_cate);
	    });
		$('#cert-div-clone').remove();
		$('#pofol-div-clone').remove();
		
		$.each($('.cert-div'), function(index, value) {
			if($(this).find("input[name='cert_name_arr[]']").val() == '') 
				$(this).remove();
		});
		$.each($('.pofol-div'), function(index, value) {
			if($(this).find("input[name='pofol_name_arr[]']").val() == '') 
				$(this).remove();
		});
		$('#frm_regist').submit();
	}
}

function add_cert_div() {
	$('#cert-div-wrap').append(cert_html);
}

function add_pofol_div() {					
	$('#pofol-div-wrap').append(pofol_html);	
	var loop = $('#pofol-div-wrap .pofol-div').last().find('.pofol_picture_div .input-file');
	var cnt = $('#pofol-div-wrap .pofol-div').length;
	$.each(loop, function(index, value) {
		$(this).attr('name', 'pofol_picture_' + cnt + '[]');
		$(this).attr('id', 'picture-' + cnt + '-' + (index+1));		
	});
	$('#pofol-div-wrap .pofol-div').last().find('.pofol_picture_div').parents('td').find('label').attr('for', 'picture-' + cnt + '-1');
}

function remove_cert_div() {
	var chk_list = $('#cert-div-wrap input[name=chk_cert]:checked');
	if(chk_list.length == 0) {
		alert('제거할 대상을 선택해주세요.');
		return;
	}
	$.each(chk_list, function(index, value) {
		$(this).parents('.cert-div').remove();
	});
}

function remove_pofol_div() {
	var chk_list = $('#pofol-div-wrap input[name=chk_pofol]:checked');
	if(chk_list.length == 0) {
		alert('제거할 대상을 선택해주세요.');
		return;
	}
	$.each(chk_list, function(index, value) {
		$(this).parents('.pofol-div').remove();
	});
}
</script>

{ #layout_footer }